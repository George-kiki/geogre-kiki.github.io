<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="author" content="George-kiki">
    <!-- Open Graph Data -->
    <meta property="og:title" content="写一个小型的MVVM框架">
    <meta property="og:description" content>
    <meta property="og:site_name" content="George-kiki">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://github.com/George-kiki">
    
        <link rel="alternate" href="/atom.xml" title="George-kiki" type="application/atom+xml">
    
    
        <link rel="icon" href="/favicon.png">
    

    <!-- Site Title -->
    <title>George-kiki</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <!-- Custom CSS -->
    
    <link rel="stylesheet" href="/css/style.light.css">

    <!-- Google Analytics -->
    

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//cdn.dode.top/Hitalk.min.js"></script>
</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/animation_sea_bg.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">写一个小型的MVVM框架</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/George-kiki">
                  
                  Github
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
    <div class="container typo">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-info text-muted">
                    
                        <!-- Author -->
                        <span class="author info">By George-kiki</span>
                    
                    <!-- Date -->
                    <span class="date-time info">On
            <span class="date">2019-09-05</span>
            <span class="time">14:09:39</span>
          </span>
                    
                        <!--  Categories  -->
                        <span class="categories info">Under 

<a href="/categories/coding/">coding</a>
</span>
                    
                </div>
                <!-- Tags -->
                
                    <div class="post-tags text-muted">
                        Tags: 

<a class="tag" href="/tags/JavaScript/">#JavaScript</a> <a class="tag" href="/tags/MVVM/">#MVVM</a>


                    </div>
                
                <!-- Post Main Content -->
                <div class="post-content">
                    <h3 id="什么是MVVM？"><a href="#什么是MVVM？" class="headerlink" title="什么是MVVM？"></a>什么是MVVM？</h3><p>说道MVVM大家肯定不陌生，目前前端流行的三大框架都是基于MVVM得理念。<br>第一个M是module（数据模型）。第二个V是view（视图）。第三个VM是ViewModule(数据模型驱动视图更新，就是双向绑定)<br><img src="https://my-blog-img.oss-cn-shenzhen.aliyuncs.com/vm/MVVM.png?Expires=1567822623&OSSAccessKeyId=TMP.hVZhSKirDvXhvo3ym1ChnCHxx9BVKAT9KvtUM9VnZiNutvYNZDwbhT5qu5aBkMwM6C2vK1s9nqU2MZGABDTDW2um3Mi1mssrc91TU96Yh63nUHyWeenUK76wwdD53E.tmp&Signature=Z0Vyct3aiAlJWH9mLB34Byq7O2c%3D" alt><br>首先在index.html写好初始化挂载对象</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--index.html--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123;message&#125;&#125;&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 这里使用AMD规范的requireJS来做模块化的方案 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/require.js/2.3.6/require.js"</span> <span class="attr">data-main</span>=<span class="string">"main"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建一个main.js，这个文件作为模块基础配置文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* main.js */</span></span><br><span class="line"><span class="built_in">require</span>.config(&#123;</span><br><span class="line">  baseUrl: <span class="string">'lib'</span>,</span><br><span class="line">  paths: &#123;</span><br><span class="line">    <span class="string">'vm'</span>: <span class="string">'vm'</span>,</span><br><span class="line">    <span class="string">'compile'</span>: <span class="string">'compile'</span>,</span><br><span class="line">    <span class="string">'observer'</span>: <span class="string">'observer'</span>,</span><br><span class="line">    <span class="string">'watcher'</span>: <span class="string">'watcher'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">require</span>([<span class="string">'vm'</span>, <span class="string">'compile'</span>, <span class="string">'observer'</span>, <span class="string">'watcher'</span>],<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> app = <span class="keyword">new</span> Vm(&#123; <span class="comment">// 初始化实例对象</span></span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      message: <span class="string">'Hello World'</span>,</span><br><span class="line">      name: <span class="string">'George-kiki'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>创建一个vm.js，这个是我们所写的MVVM的实例对象入口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* vm.js */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vm</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.$el = options.el;</span><br><span class="line">    <span class="keyword">this</span>.$data = options.data;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.$el) &#123; <span class="comment">// 判断一下是否有挂载对象</span></span><br><span class="line">      <span class="keyword">new</span> Observer(<span class="keyword">this</span>.$data); <span class="comment">// 传入响应对象</span></span><br><span class="line">      <span class="keyword">this</span>.proxyData (<span class="keyword">this</span>.$data);</span><br><span class="line">      <span class="keyword">new</span> Compile(<span class="keyword">this</span>) <span class="comment">// 将MVVM的实例对象（this）传入模板编译方法类中</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  proxyData (data) &#123; <span class="comment">/* 将$data的属性代理到this上 */</span> </span><br><span class="line">      <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">keys</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(<span class="keyword">this</span>, keys, &#123;</span><br><span class="line">          <span class="keyword">get</span> () &#123;</span><br><span class="line">            <span class="keyword">return</span> data[keys]</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="keyword">set</span> (newValue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newValue !== data[keys])  &#123;</span><br><span class="line">              data[keys] = newValue</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个compile.js 指令和文本表达式的编译都在这个文件中完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* compile.js */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compile</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(vm) &#123;</span><br><span class="line">    <span class="keyword">let</span> el = vm.$el;</span><br><span class="line">    <span class="keyword">this</span>.vm = vm;</span><br><span class="line">    <span class="keyword">this</span>.el = <span class="keyword">this</span>.isElementsNodes(el) ? el : <span class="built_in">document</span>.querySelector(el)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.el) &#123;</span><br><span class="line">      <span class="keyword">let</span> fragment = <span class="keyword">this</span>.createFragment(<span class="keyword">this</span>.el)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 辅助方法</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line">  <span class="comment">/* 判断是否为元素节点 */</span></span><br><span class="line">  isElementsNodes (node) &#123;</span><br><span class="line">    <span class="keyword">return</span> node.nodeType === <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 判断元素自定义属性否为指令 */</span></span><br><span class="line">  isDirective (attr) &#123;</span><br><span class="line">    <span class="keyword">return</span> attr.includes(<span class="string">'v-'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * 核心方法</span></span><br><span class="line"><span class="comment">  * */</span></span><br><span class="line">  createFragment (node) &#123; <span class="comment">/* 创建文档内存,将页面中都元素存放到内存中 */</span></span><br><span class="line">    <span class="keyword">let</span> fragment = <span class="built_in">document</span>.createDocumentFragment();</span><br><span class="line">    <span class="keyword">let</span> fragmentNodes;</span><br><span class="line">    <span class="keyword">while</span> (fragmentNodes = node.firstChild) &#123;</span><br><span class="line">      fragment.append(fragmentNodes)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fragment</span><br><span class="line">  &#125;</span><br><span class="line">  compile (node) &#123;</span><br><span class="line">    <span class="keyword">let</span> childeNodes = node.childNodes;</span><br><span class="line">    <span class="comment">/* 拿到内存中都所有节点 因为是类数组 所有需要转成数组</span></span><br><span class="line"><span class="comment">    使用ES6的Array.from方法即可 也可以使用 Array.prototype.slice.call()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">Array</span>.from(childeNodes).forEach(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* 判断是文本节点还是元素节点  元素节点下面是否还有节点 需要递归遍历一下  */</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isElementsNodes(el)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.compileElements(el);</span><br><span class="line">        <span class="keyword">this</span>.compile(el)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.compileText(el)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 判断元素中都自定义属性是否是指令 从attributes这个属性拿到元素自定义属性的类数组 */</span></span><br><span class="line">  compileElements (node) &#123;</span><br><span class="line">    <span class="keyword">let</span> attr = node.attributes;</span><br><span class="line">    <span class="built_in">Array</span>.from(attr).forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.isDirective(item.name)) &#123;</span><br><span class="line">        <span class="keyword">let</span> expr = item.value;</span><br><span class="line">        <span class="keyword">let</span> [, type] = item.name.split(<span class="string">'-'</span>);</span><br><span class="line">        compileUtils[type](<span class="keyword">this</span>.vm, node, expr)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 使用正则判断文本节点是否为文本表达式 */</span></span><br><span class="line">  compileText (node) &#123;</span><br><span class="line">    <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;([^&#125;]+)\&#125;\&#125;/</span>;</span><br><span class="line">    <span class="keyword">let</span> nodes = node.textContent;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(nodes)) &#123;</span><br><span class="line">      compileUtils[<span class="string">'text'</span>](<span class="keyword">this</span>.vm, node, nodes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 编译工具 */</span></span><br><span class="line"><span class="keyword">let</span> compileUtils = &#123;</span><br><span class="line">  getVal (vm, expr) &#123; <span class="comment">/* message.name的链式操作变为message["name"]*/</span></span><br><span class="line">    expr = expr.split(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">return</span> expr.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> prev[next], vm.data)</span><br><span class="line">  &#125;,</span><br><span class="line">  getText (vm, expr, reg) &#123; <span class="comment">/* 文本值处理 */</span> </span><br><span class="line">    <span class="keyword">return</span> expr.replace(reg, (...arguments) =&gt; <span class="keyword">this</span>.getVal(vm, <span class="built_in">arguments</span>[<span class="number">1</span>]))</span><br><span class="line">  &#125;,</span><br><span class="line">  setValue(vm, expr, value) &#123; <span class="comment">/* input改变做值变化 */</span> </span><br><span class="line">    expr = expr.split(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">return</span> expr.reduce(<span class="function">(<span class="params">prev, next, currentIndex</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (expr.length - <span class="number">1</span> === currentIndex ) &#123;</span><br><span class="line">         <span class="keyword">return</span> prev[next] = value</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> prev[next]</span><br><span class="line">    &#125;,vm.data)</span><br><span class="line">  &#125;,</span><br><span class="line">  text (vm, node, expr) &#123; <span class="comment">/* 表达式和v-text编译 */</span> </span><br><span class="line">    <span class="keyword">let</span> textUpdater = <span class="keyword">this</span>.updater.textUpdater;</span><br><span class="line">    <span class="keyword">let</span> reg = <span class="regexp">/\&#123;\&#123;([^&#125;]+)\&#125;\&#125;/g</span>;</span><br><span class="line">    <span class="keyword">if</span> (reg.test(expr)) &#123;</span><br><span class="line">      expr.replace(reg, (...arguments) =&gt; &#123;</span><br><span class="line">        <span class="keyword">new</span> Watcher(vm, <span class="built_in">arguments</span>[<span class="number">1</span>], (OldValue, newValue) =&gt; &#123; <span class="comment">/* 数据变化了 触发视图更新  */</span></span><br><span class="line">          textUpdater&amp;&amp;textUpdater(node, <span class="keyword">this</span>.getText(vm, expr, reg))</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;);</span><br><span class="line">      textUpdater&amp;&amp;textUpdater(node, <span class="keyword">this</span>.getText(vm, expr, reg))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> Watcher(vm, expr,(oldValue, newValue) =&gt; textUpdater&amp;&amp;textUpdater(node, <span class="keyword">this</span>.getVal(vm, expr)));</span><br><span class="line">      textUpdater&amp;&amp;textUpdater(node, <span class="keyword">this</span>.getVal(vm, expr))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  model (vm, node, expr) &#123; <span class="comment">/* v-model 编译 */</span> </span><br><span class="line">    <span class="keyword">let</span> modelUpdater = <span class="keyword">this</span>.updater.modelUpdater;</span><br><span class="line">    <span class="keyword">new</span> Watcher(vm, expr, (oldValue, newValue) =&gt; modelUpdater&amp;&amp;modelUpdater(node, <span class="keyword">this</span>.getVal(vm, expr)));</span><br><span class="line">    node.addEventListener(<span class="string">'input'</span>, (e) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> value = e.target.value;</span><br><span class="line">     <span class="keyword">this</span>.setValue(vm, expr, value);</span><br><span class="line">    &#125;);</span><br><span class="line">    modelUpdater&amp;&amp;modelUpdater(node, <span class="keyword">this</span>.getVal(vm, expr))</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">if</span> (vm, node, expr) &#123; <span class="comment">/* v-if 编译 */</span> </span><br><span class="line">    <span class="keyword">let</span> ifUpdater = <span class="keyword">this</span>.updater.ifUpdater;</span><br><span class="line">    <span class="keyword">new</span> Watcher(vm, expr, (oldValue, newValue) =&gt; ifUpdater&amp;&amp;ifUpdater(node, <span class="keyword">this</span>.getVal(vm, expr)));</span><br><span class="line">    ifUpdater&amp;&amp;ifUpdater(node, <span class="keyword">this</span>.getVal(vm, expr))</span><br><span class="line">  &#125;,</span><br><span class="line">  show (vm, node, expr) &#123; <span class="comment">/* v-show 编译 */</span> </span><br><span class="line">    <span class="keyword">let</span> showUpdater = <span class="keyword">this</span>.updater.showUpdater;</span><br><span class="line">    <span class="keyword">new</span> Watcher(vm, expr, (oldValue, newValue) =&gt; showUpdater&amp;&amp;showUpdater(node, <span class="keyword">this</span>.getVal(vm, expr)));</span><br><span class="line">    showUpdater&amp;&amp;showUpdater(node, <span class="keyword">this</span>.getVal(vm, expr))</span><br><span class="line">  &#125;,</span><br><span class="line">  updater: &#123;<span class="comment">/* 编译时做的事情 */</span> </span><br><span class="line">    modelUpdater (node, value) &#123;</span><br><span class="line">      node.value = value</span><br><span class="line">    &#125;,</span><br><span class="line">    textUpdater (node, value) &#123;</span><br><span class="line">      node.textContent = value</span><br><span class="line">    &#125;,</span><br><span class="line">    ifUpdater (node, value) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!value) &#123;</span><br><span class="line">        node.remove()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    showUpdater (node, value) &#123;</span><br><span class="line">      <span class="keyword">if</span> (value) &#123;</span><br><span class="line">        node.style.display = <span class="string">'block'</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.style.display = <span class="string">'none'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个observer.js文件，数据响应式和数据修改触发视图更新在这个文件完成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Obserber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.obserber(data)</span><br><span class="line">  &#125;</span><br><span class="line">  observer (data) &#123; <span class="comment">/* 判断date是不是对象 */</span></span><br><span class="line">    <span class="keyword">if</span> (!data || <span class="keyword">typeof</span> data !== <span class="string">'object'</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">Object</span>.keys(data).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.definedReactive(data, key, data[key]);</span><br><span class="line">      <span class="keyword">this</span>.observer(data[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  definedReactive (obj, key, value) &#123;</span><br><span class="line">    <span class="keyword">let</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> dep = <span class="keyword">new</span> Dep();</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">      configurable: <span class="literal">true</span>,</span><br><span class="line">      enumerable: <span class="literal">true</span>,</span><br><span class="line">      <span class="keyword">get</span> () &#123;</span><br><span class="line">        Dep.target&amp;&amp;dep.addSubs(Dep.target); <span class="comment">/* 当节点属性发生变化时 先会拿一次旧的值 这时拿到了watcher实例放到数组中 */</span> </span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="keyword">set</span> (newValue) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newValue !== value) &#123;</span><br><span class="line">          that.observer(value);</span><br><span class="line">          value = newValue;</span><br><span class="line">          dep.notify() <span class="comment">/* 当前值与旧值不相等时， 通知所有人更新 */</span> </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.subs = []</span><br><span class="line">  &#125;</span><br><span class="line">  addSubs (watcher) &#123;</span><br><span class="line">    <span class="keyword">this</span>.subs.push(watcher)</span><br><span class="line">  &#125;</span><br><span class="line">  notify () &#123;</span><br><span class="line">    <span class="keyword">this</span>.subs.forEach(<span class="function"><span class="params">watcher</span> =&gt;</span> watcher.updater()) <span class="comment">// 遍历subs数组中的观察者，当数据变化触发每一个观察者更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个watcher.js，这里做数据改变后相应都操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(vm ,expr, callback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.vm = vm;</span><br><span class="line">    <span class="keyword">this</span>.expr = expr;</span><br><span class="line">    <span class="keyword">this</span>.callback = callback;</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.get()</span><br><span class="line">  &#125;</span><br><span class="line">  getVal (vm, expr) &#123;</span><br><span class="line">    expr = expr.split(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">return</span> expr.reduce(<span class="function">(<span class="params">prev, next</span>) =&gt;</span> prev[next], vm.data)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">get</span> () &#123; <span class="comment">/*获取旧的值*/</span> </span><br><span class="line">    Dep.target = <span class="keyword">this</span>; <span class="comment">/*利用class属性得到watcher实例*/</span> </span><br><span class="line">    <span class="keyword">let</span> value = <span class="keyword">this</span>.getVal(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.expr); <span class="comment">/*拿到旧的值*/</span> </span><br><span class="line">    Dep.target = <span class="literal">null</span>; <span class="comment">/*每次节点属性改变都是一个新的监听实例*/</span> </span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;</span><br><span class="line">  update () &#123; <span class="comment">/*更新方法*/</span> </span><br><span class="line">    <span class="keyword">let</span> newValue = <span class="keyword">this</span>.getVal(<span class="keyword">this</span>.vm, <span class="keyword">this</span>.expr);</span><br><span class="line">    <span class="keyword">let</span> oldValue = <span class="keyword">this</span>.value;</span><br><span class="line">    <span class="keyword">if</span> (oldValue !== newValue) &#123;</span><br><span class="line">      <span class="keyword">this</span>.callback(oldValue, newValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码写完了，来看看效果是否可行<br><img src="https://my-blog-img.oss-cn-shenzhen.aliyuncs.com/vm/code-example.gif?Expires=1567822016&OSSAccessKeyId=TMP.hVZhSKirDvXhvo3ym1ChnCHxx9BVKAT9KvtUM9VnZiNutvYNZDwbhT5qu5aBkMwM6C2vK1s9nqU2MZGABDTDW2um3Mi1mssrc91TU96Yh63nUHyWeenUK76wwdD53E.tmp&Signature=bgBk6TacEnxSa%2FUC26%2Bb4CTH6WQ%3D" alt><br>在控制台里修改一下data.name的值看看视图是否发生改变<br><img src="https://my-blog-img.oss-cn-shenzhen.aliyuncs.com/vm/codeShow.gif?Expires=1567822045&OSSAccessKeyId=TMP.hVZhSKirDvXhvo3ym1ChnCHxx9BVKAT9KvtUM9VnZiNutvYNZDwbhT5qu5aBkMwM6C2vK1s9nqU2MZGABDTDW2um3Mi1mssrc91TU96Yh63nUHyWeenUK76wwdD53E.tmp&Signature=Own55cZ9RZ%2F1mpXBi8qKuemoyWA%3D" alt>  </p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在这个小demo中，大致了解了MVVM从实例化到数据发生改变再到视图更新都做了些什么</p>

                </div>
            </div>
        </div>
    </div>
    <div id="comment"></div>
</article>
<script>
  new Hitalk({
    el: '#comment' ,
    appId: 'VnAjBQDKjiiQGPcIkYu4TGDm-gzGzoHsz',
    appKey: '1T0fJve6IS0KxGXnCXg6luIl',
    placeholder: '快来评论吧',
    path:window.location.pathname,
    avatar:'mm'
  });
</script>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          萌萌哒博客 <a target="_blank" href="https://github.com/George-kiki">George-kiki</a>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

